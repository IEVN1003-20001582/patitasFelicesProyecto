<div class="w-full p-6 md:p-8"> 
    <!-- ============================ -->
    <!-- SECCIÓN 1: KPIs (Tarjetas Superiores) -->
    <!-- ============================ -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
        <div class="bg-white p-6 rounded-2xl shadow-lg flex items-center">
            <div class="p-3 bg-secondary-teal rounded-full">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 text-white">
                    <path d="M12 2a9.1 9.1 0 0 0-6.8 3.3c-2.4 2.8-2.8 6.9-1.2 10.4A8.8 8.8 0 0 0 12 22a8.8 8.8 0 0 0 8-6.3c1.6-3.5 1.2-7.6-1.2-10.4A9.1 9.1 0 0 0 12 2zm3.2 10.1c-.8.8-1.8 1.2-2.8 1.2s-2-.4-2.8-1.2a3.8 3.8 0 0 1 0-5.5c.8-.8 1.8-1.2 2.8-1.2s2 .4 2.8 1.2a3.8 3.8 0 0 1 0 5.5z"/>
                </svg>
            </div>
            <div class="ml-4">
                <p class="text-gray-500">Total de Pacientes</p>
                <p class="text-2xl font-bold text-primary-dark">{{ kpis.total }}</p>
            </div>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-lg flex items-center">
            <div class="p-3 bg-secondary-teal rounded-full">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-white">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
                </svg>
            </div>
            <div class="ml-4">
                <p class="text-gray-500">Nuevas Mascotas (Est.)</p>
                <p class="text-2xl font-bold text-primary-dark">{{ kpis.nuevas }}</p>
            </div>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-lg flex items-center">
            <div class="p-3 bg-light-red rounded-full">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-white">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                </svg>
            </div>
            <div class="ml-4">
                <p class="text-gray-500">Pacientes con Alergias</p>
                <p class="text-2xl font-bold text-light-red">{{ kpis.alergias }}</p>
            </div>
        </div>
    </div>

    <!-- ============================ -->
    <!-- SECCIÓN 2: Barra de Herramientas -->
    <!-- ============================ -->
    <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
        <div class="relative w-full max-w-md">
            <input type="text" 
                   [(ngModel)]="textoBusqueda" 
                   (input)="filtrarMascotas()"
                   placeholder="Buscar mascota por nombre o dueño..." 
                   class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-secondary-teal">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-5 w-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
            </svg>
        </div>
        <div class="flex space-x-4">
            <button (click)="abrirModalFiltros()" class="bg-white text-gray-700 border border-gray-300 font-semibold py-2 px-4 rounded-lg text-sm hover:bg-gray-50 transition duration-300 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75" />
                </svg>
                Filtros
            </button>
             <button (click)="abrirModalAgregar()" class="bg-secondary-teal text-white font-semibold py-2 px-5 rounded-lg text-sm shadow-md hover:bg-opacity-80 transition duration-300 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                </svg>
                Agregar Mascota
            </button>
        </div>
    </div>

    <!-- ============================ -->
    <!-- SECCIÓN 3: Grid de Mascotas -->
    <!-- ============================ -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        
        <div *ngFor="let mascota of mascotasFiltradas" 
             (click)="abrirModalDetalle(mascota)"
             class="btn-detalle-mascota bg-white rounded-2xl shadow-lg overflow-hidden transform hover:-translate-y-1 hover:shadow-xl transition duration-300 cursor-pointer">
            
            <!-- CAMBIO PRINCIPAL AQUÍ: Logica de Foto vs Texto -->
            <div class="h-40 bg-gray-200 relative flex items-center justify-center overflow-hidden">
                <!-- 1. Foto Real (Si existe URL) -->
                <img *ngIf="mascota.foto_url && mascota.foto_url.length > 10" 
                     [src]="mascota.foto_url" 
                     alt="Foto de {{mascota.nombre}}" 
                     class="h-full w-full object-cover transition-transform duration-500 hover:scale-110"
                     onerror="this.style.display='none'">
                
                <!-- 2. Texto de Respaldo (Si NO hay foto o falló) -->
                <div *ngIf="!mascota.foto_url || mascota.foto_url.length <= 10" 
                     class="absolute inset-0 flex items-center justify-center text-gray-400 font-bold text-4xl select-none bg-gray-100">
                    {{ mascota.nombre }}
                </div>
            </div>

            <div class="p-5">
                <h3 class="text-xl font-bold text-primary-dark truncate">{{ mascota.nombre }}</h3>
                <p class="text-gray-600 text-sm">{{ mascota.especie }} - {{ mascota.raza }}</p>
                
                <div class="my-3 h-6">
                    <span *ngIf="mascota.alergias && mascota.alergias.length > 2 && mascota.alergias !== 'Ninguna'" 
                          class="px-3 py-1 text-xs font-bold text-red-800 bg-red-200 rounded-full animate-pulse">
                        ¡ALERGIAS!
                    </span>
                    <span *ngIf="!mascota.alergias || mascota.alergias === 'Ninguna'" 
                          class="px-3 py-1 text-xs font-semibold text-gray-700 bg-gray-100 rounded-full">
                        Sin Alertas
                    </span>
                </div>

                <div class="space-y-2 text-sm text-gray-500">
                    <div class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-4 w-4 mr-2"><path d="M10 8a3 3 0 100-6 3 3 0 000 6zM3.465 14.493a1.23 1.23 0 00.41 1.412A9.957 9.957 0 0010 18c2.31 0 4.438-.784 6.126-2.095a1.23 1.23 0 00.41-1.412A9.99 9.99 0 0010 12c-2.31 0-4.438.784-6.126 2.095z" /></svg>
                        Dueño: {{ mascota.nombre_dueno || 'Sin asignar' }}
                    </div>
                    <div class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-4 w-4 mr-2 text-secondary-teal"><path d="M10.75 2.75a.75.75 0 00-1.5 0v8.614L6.295 8.235a.75.75 0 10-1.09 1.03l4.25 4.5a.75.75 0 001.09 0l4.25-4.5a.75.75 0 00-1.09-1.03l-2.955 3.129V2.75z" /><path d="M3.5 12.75a.75.75 0 00-1.5 0v2.5A2.75 2.75 0 004.75 18h10.5A2.75 2.75 0 0018 15.25v-2.5a.75.75 0 00-1.5 0v2.5c0 .69-.56 1.25-1.25 1.25H4.75c-.69 0-1.25-.56-1.25-1.25v-2.5z" /></svg>
                        Peso: {{ mascota.peso }} kg
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- ============================ -->
<!-- MODAL AGREGAR MASCOTA -->
<!-- ============================ -->
<div *ngIf="mostrarModalAgregar" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl animate-fade-in-down">
        <div class="flex justify-between items-center p-5 border-b">
            <h3 class="text-xl font-bold text-primary-dark">Registrar Nueva Mascota</h3>
            <button (click)="cerrarModalAgregar()" class="text-gray-400 hover:text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </div>
        <div class="p-6 max-h-[70vh] overflow-y-auto">
            <form class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- CAMBIO AQUÍ: Sección de Foto para URL -->
                    <div class="md:col-span-1 flex flex-col items-center">
                        <label class="block text-gray-700 mb-2 font-semibold">Foto (URL)</label>
                        
                        <!-- Previsualización -->
                        <div class="w-32 h-32 rounded-full bg-gray-200 flex items-center justify-center mb-2 overflow-hidden border-2 border-secondary-teal relative">
                            <!-- Si hay URL -->
                            <img *ngIf="nuevaMascota.foto_url" [src]="nuevaMascota.foto_url" class="w-full h-full object-cover" onerror="this.style.display='none'">
                            <!-- Icono si no hay URL -->
                            <svg *ngIf="!nuevaMascota.foto_url" xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l-1.586-1.586a2 2 0 00-2.828 0L6 14m6-6l.25-.25a2 2 0 012.828 0l.25.25m-3 3l.25.25a2 2 0 002.828 0l.25-.25m-3-3l.25-.25a2 2 0 012.828 0l.25.25m0 0l-3 3m0 0l-3-3m3 3V3" /></svg>
                        </div>
                    
                        <!-- Input de Texto para la URL -->
                        <input [(ngModel)]="nuevaMascota.foto_url" name="foto" type="text" placeholder="Pega aquí el link..." class="text-xs w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-secondary-teal text-center">
                        <p class="text-xs text-gray-400 mt-1 text-center">Ej: https://imgur.com/perro.jpg</p>
                    </div>
                    
                    <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2">
                            <label class="block text-gray-700 mb-1 font-semibold">Nombre</label>
                            <input [(ngModel)]="nuevaMascota.nombre" name="nombre" type="text" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-secondary-teal" required>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-gray-700 mb-1 font-semibold">Dueño (Cliente)</label>
                            <select [(ngModel)]="nuevaMascota.cliente_id" name="cliente_id" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-secondary-teal" required>
                                <option [value]="0">Seleccionar cliente...</option>
                                <option *ngFor="let cli of clientes" [value]="cli.id">{{ cli.nombre }}</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1 font-semibold">Especie</label>
                            <input [(ngModel)]="nuevaMascota.especie" name="especie" type="text" placeholder="Perro/Gato" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-secondary-teal">
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1 font-semibold">Raza</label>
                            <input [(ngModel)]="nuevaMascota.raza" name="raza" type="text" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-secondary-teal">
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1 font-semibold">Nacimiento</label>
                            <input [(ngModel)]="nuevaMascota.fecha_nacimiento" name="fecha" type="date" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-secondary-teal">
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1 font-semibold">Sexo</label>
                            <select [(ngModel)]="nuevaMascota.sexo" name="sexo" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-secondary-teal">
                                <option value="Macho">Macho</option>
                                <option value="Hembra">Hembra</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1 font-semibold">Peso (kg)</label>
                            <input [(ngModel)]="nuevaMascota.peso" name="peso" type="number" step="0.1" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-secondary-teal">
                        </div>
                    </div>
                    <div class="md:col-span-3">
                        <label class="block text-gray-700 mb-1 font-semibold">Alergias</label>
                        <textarea [(ngModel)]="nuevaMascota.alergias" name="alergias" rows="3" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-secondary-teal"></textarea>
                    </div>
                </div>
            </form>
        </div>
        <div class="flex justify-end p-5 border-t space-x-4">
            <button (click)="cerrarModalAgregar()" class="bg-white text-gray-700 border border-gray-300 font-semibold py-2 px-4 rounded-lg hover:bg-gray-50 transition duration-300">
                Cancelar
            </button>
            <button (click)="guardarMascota()" class="bg-secondary-teal text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-opacity-80 transition duration-300">
                Guardar Mascota
            </button>
        </div>
    </div>
</div>

<!-- ============================ -->
<!-- MODAL DETALLE MASCOTA -->
<!-- ============================ -->
<div *ngIf="mostrarModalDetalle && mascotaSeleccionada" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-4xl animate-fade-in-down">
        <div class="flex justify-between items-center p-5 border-b">
            <div class="flex items-center space-x-3">
                <!-- FOTO EN HEADER DEL MODAL -->
                <div class="h-16 w-16 rounded-full bg-secondary-yellow flex items-center justify-center text-2xl font-bold text-white overflow-hidden">
                    <img *ngIf="mascotaSeleccionada.foto_url" [src]="mascotaSeleccionada.foto_url" class="h-full w-full object-cover" onerror="this.style.display='none'">
                    <span *ngIf="!mascotaSeleccionada.foto_url">{{ mascotaSeleccionada.nombre.charAt(0) }}</span>
                </div>
                <div>
                    <h3 class="text-2xl font-bold text-primary-dark">{{ mascotaSeleccionada.nombre }}</h3>
                    <p class="text-gray-600">{{ mascotaSeleccionada.especie }} - {{ mascotaSeleccionada.raza }}</p>
                </div>
            </div>
            <div class="flex space-x-3">
                <button (click)="cerrarModalDetalle()" class="text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
        </div>
        
        <!-- Tabs de Navegación -->
        <div class="border-b border-gray-200">
            <nav class="flex space-x-4 md:space-x-8 px-6 -mb-px cursor-pointer">
                <a (click)="cambiarTab('info')" [class.border-secondary-teal]="tabActiva === 'info'" class="py-4 px-1 border-b-4 text-sm font-medium hover:text-secondary-teal transition-colors" [ngClass]="{'text-secondary-teal': tabActiva === 'info', 'text-gray-500': tabActiva !== 'info'}">Info General</a>
                <a (click)="cambiarTab('historial')" [class.border-secondary-teal]="tabActiva === 'historial'" class="py-4 px-1 border-b-4 text-sm font-medium hover:text-secondary-teal transition-colors" [ngClass]="{'text-secondary-teal': tabActiva === 'historial', 'text-gray-500': tabActiva !== 'historial'}">Historial Clínico</a>
                <a (click)="cambiarTab('vacunacion')" [class.border-secondary-teal]="tabActiva === 'vacunacion'" class="py-4 px-1 border-b-4 text-sm font-medium hover:text-secondary-teal transition-colors" [ngClass]="{'text-secondary-teal': tabActiva === 'vacunacion', 'text-gray-500': tabActiva !== 'vacunacion'}">Vacunación</a>
                <a (click)="cambiarTab('citas')" [class.border-secondary-teal]="tabActiva === 'citas'" class="py-4 px-1 border-b-4 text-sm font-medium hover:text-secondary-teal transition-colors" [ngClass]="{'text-secondary-teal': tabActiva === 'citas', 'text-gray-500': tabActiva !== 'citas'}">Próximas Citas</a>
            </nav>
        </div>

        <div class="p-6 max-h-[60vh] overflow-y-auto">
            
            <!-- TAB: INFO -->
            <div *ngIf="tabActiva === 'info'" class="space-y-4">
                <div *ngIf="mascotaSeleccionada.alergias && mascotaSeleccionada.alergias !== 'Ninguna'" class="p-4 bg-red-100 border border-red-300 rounded-lg">
                    <h4 class="font-bold text-red-800">¡Alerta de Alergia!</h4>
                    <p class="text-sm text-red-700">{{ mascotaSeleccionada.alergias }}</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-500">Dueño</label>
                        <p class="text-md text-gray-800">{{ mascotaSeleccionada.nombre_dueno }}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-500">Fecha de Nacimiento</label>
                        <p class="text-md text-gray-800">{{ mascotaSeleccionada.fecha_nacimiento }}</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-500">Peso</label>
                        <p class="text-md text-gray-800">{{ mascotaSeleccionada.peso }} kg</p>
                    </div>
                </div>
                
                <div class="pt-4 border-t flex justify-between mt-4">
                    <div>
                        <button (click)="abrirModalEditar()" class="text-secondary-teal font-semibold text-sm hover:underline">Editar Información</button>
                    </div>
                    <button (click)="abrirModalArchivar()" class="bg-white text-light-red border border-light-red font-semibold py-2 px-4 rounded-lg text-sm hover:bg-red-50 transition duration-300">
                        Archivar Mascota
                    </button>
                </div>
            </div>
            
            <!-- TAB: HISTORIAL (DINÁMICO) -->
            <div *ngIf="tabActiva === 'historial'" class="space-y-4">
                <div class="flex justify-between items-center">
                    <h4 class="text-lg font-semibold text-primary-dark">Tratamientos Anteriores</h4>
                    <button (click)="abrirModalTratamiento()" class="bg-secondary-teal text-white font-semibold py-2 px-4 rounded-lg text-sm shadow-md hover:bg-opacity-80 transition duration-300 flex items-center">
                        Agregar Tratamiento
                    </button>
                </div>
                
                <div class="space-y-3">
                    <div *ngIf="historialMascota.length === 0" class="text-center text-gray-400 py-4">No hay registros médicos aún.</div>
                    
                    <div *ngFor="let item of historialMascota" class="p-4 border rounded-lg hover:bg-gray-50 transition-colors">
                        <div class="flex justify-between">
                            <p class="font-semibold text-gray-800">{{ item.diagnostico || 'Consulta General' }}</p>
                            <span class="text-sm text-gray-500">{{ item.fecha | date:'shortDate' }}</span>
                        </div>
                        <div class="mt-2 text-sm text-gray-600">
                            <p><strong>Tratamiento:</strong> {{ item.tratamiento_aplicado }}</p>
                            <p *ngIf="item.medicamentos_recetados" class="mt-1"><strong>Receta:</strong> {{ item.medicamentos_recetados }}</p>
                        </div>
                        <p class="text-xs text-gray-500 mt-2 pt-2 border-t border-gray-100">Atendido por: {{ item.veterinario }}</p>
                    </div>
                </div>
            </div>

            <!-- TAB: VACUNACION (DINÁMICO) -->
            <div *ngIf="tabActiva === 'vacunacion'" class="space-y-4">
                <div class="flex justify-between items-center">
                    <h4 class="text-lg font-semibold text-primary-dark">Calendario de Vacunación</h4>
                    <button (click)="abrirModalVacuna()" class="bg-secondary-teal text-white font-semibold py-2 px-4 rounded-lg text-sm shadow-md hover:bg-opacity-80 transition duration-300 flex items-center">
                        Registrar Vacuna
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-semibold text-gray-600">Vacuna</th>
                                <th class="px-4 py-2 text-left text-xs font-semibold text-gray-600">Fecha</th>
                                <th class="px-4 py-2 text-left text-xs font-semibold text-gray-600">Próxima</th>
                                <th class="px-4 py-2 text-left text-xs font-semibold text-gray-600">Vet</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y">
                            <tr *ngFor="let vac of vacunasMascota">
                                <td class="px-4 py-3 text-sm font-medium text-gray-800">{{ vac.nombre_vacuna }}</td>
                                <td class="px-4 py-3 text-sm text-gray-600">{{ vac.fecha_aplicacion | date:'shortDate' }}</td>
                                <td class="px-4 py-3 text-sm font-semibold text-light-red">{{ vac.fecha_proxima_dosis ? (vac.fecha_proxima_dosis | date:'shortDate') : 'N/A' }}</td>
                                <td class="px-4 py-3 text-sm text-gray-500">{{ vac.veterinario }}</td>
                            </tr>
                            <tr *ngIf="vacunasMascota.length === 0">
                                <td colspan="4" class="text-center py-4 text-gray-400">Sin vacunas registradas.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- TAB: CITAS (DINÁMICO) -->
            <div *ngIf="tabActiva === 'citas'" class="space-y-4">
                <h4 class="text-lg font-semibold text-primary-dark">Próximas Citas</h4>
                <div *ngIf="citasMascota.length === 0" class="text-center text-gray-400 py-4">No hay citas programadas.</div>
                
                <div *ngFor="let cita of citasMascota" class="p-4 border border-secondary-teal rounded-lg">
                    <div class="flex justify-between items-center mb-1">
                        <p class="font-semibold text-gray-800">{{ cita.motivo }}</p>
                        <span class="text-sm text-gray-500">{{ cita.fecha_hora | date:'medium' }}</span>
                    </div>
                    <p class="text-sm text-gray-600">Con: <span class="font-medium">{{ cita.nombre_veterinario || 'Por asignar' }}</span></p>
                    <span class="text-xs px-2 py-1 rounded bg-yellow-100 text-yellow-800">{{ cita.estado }}</span>
                </div>
            </div>

        </div>
    </div>
</div>

<div *ngIf="mostrarModalEditar" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[60]">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl animate-fade-in-down">
        <div class="flex justify-between items-center p-5 border-b">
            <h3 class="text-xl font-bold text-primary-dark">Editar Mascota</h3>
            <button (click)="cerrarModalEditar()" class="text-gray-400 hover:text-gray-600">X</button>
        </div>
        <div class="p-6 max-h-[70vh] overflow-y-auto">
            <form class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Foto -->
                    <div class="md:col-span-1 flex flex-col items-center">
                        <label class="block text-gray-700 mb-2 font-semibold">Foto (URL)</label>
                        <div class="w-32 h-32 rounded-full bg-gray-200 flex items-center justify-center mb-2 overflow-hidden border-2 border-secondary-teal relative">
                            <img *ngIf="mascotaEditando.foto_url" [src]="mascotaEditando.foto_url" class="w-full h-full object-cover" onerror="this.style.display='none'">
                            <span *ngIf="!mascotaEditando.foto_url" class="text-4xl text-gray-400 font-bold">{{ mascotaEditando.nombre?.charAt(0) }}</span>
                        </div>
                        <input [(ngModel)]="mascotaEditando.foto_url" name="foto_edit" type="text" placeholder="Link de la foto..." class="text-xs w-full px-3 py-2 border rounded-lg text-center">
                    </div>
                    
                    <!-- Datos -->
                    <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2">
                            <label class="block text-gray-700 mb-1 font-semibold">Nombre</label>
                            <input [(ngModel)]="mascotaEditando.nombre" name="nombre_edit" type="text" class="w-full px-3 py-2 border rounded-lg" required>
                        </div>
                        <!-- Nota: El dueño NO se suele editar por seguridad, pero lo mostramos deshabilitado -->
                        <div class="md:col-span-2">
                            <label class="block text-gray-700 mb-1 font-semibold">Dueño</label>
                            <input [value]="mascotaSeleccionada.nombre_dueno" disabled class="w-full px-3 py-2 border rounded-lg bg-gray-100 text-gray-500 cursor-not-allowed">
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1 font-semibold">Especie</label>
                            <input [(ngModel)]="mascotaEditando.especie" name="especie_edit" type="text" class="w-full px-3 py-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1 font-semibold">Raza</label>
                            <input [(ngModel)]="mascotaEditando.raza" name="raza_edit" type="text" class="w-full px-3 py-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1 font-semibold">Nacimiento</label>
                            <input [(ngModel)]="mascotaEditando.fecha_nacimiento" name="fecha_edit" type="date" class="w-full px-3 py-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1 font-semibold">Sexo</label>
                            <select [(ngModel)]="mascotaEditando.sexo" name="sexo_edit" class="w-full px-3 py-2 border rounded-lg">
                                <option value="Macho">Macho</option>
                                <option value="Hembra">Hembra</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1 font-semibold">Peso (kg)</label>
                            <input [(ngModel)]="mascotaEditando.peso" name="peso_edit" type="number" step="0.1" class="w-full px-3 py-2 border rounded-lg">
                        </div>
                    </div>
                    <div class="md:col-span-3">
                        <label class="block text-gray-700 mb-1 font-semibold">Alergias</label>
                        <textarea [(ngModel)]="mascotaEditando.alergias" name="alergias_edit" rows="3" class="w-full px-3 py-2 border rounded-lg"></textarea>
                    </div>
                </div>
            </form>
        </div>
        <div class="flex justify-end p-5 border-t space-x-4">
            <button (click)="cerrarModalEditar()" class="bg-white border border-gray-300 px-4 py-2 rounded-lg">Cancelar</button>
            <button (click)="guardarEdicionMascota()" class="bg-secondary-teal text-white px-4 py-2 rounded-lg shadow-md hover:bg-opacity-80">Guardar Cambios</button>
        </div>
    </div>
</div>

<!-- ============================ -->
<!-- MODAL AGREGAR TRATAMIENTO -->
<!-- ============================ -->
<div *ngIf="mostrarModalTratamiento" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-[60]">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg animate-fade-in-down">
        <div class="flex justify-between items-center p-5 border-b">
            <h3 class="text-xl font-bold text-primary-dark">Agregar Tratamiento</h3>
            <button (click)="cerrarModalTratamiento()" class="text-gray-400 hover:text-gray-600">X</button>
        </div>
        <div class="p-6 space-y-4">
            <div>
                <label class="block text-gray-700 mb-1 font-semibold">Veterinario</label>
                <select [(ngModel)]="nuevoHistorial.veterinario_id" name="vet_id" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-secondary-teal">
                    <option [value]="0">Selecciona...</option>
                    <option *ngFor="let v of veterinarios" [value]="v.id">{{ v.nombre_completo }}</option>
                </select>
            </div>
            <div>
                <label class="block text-gray-700 mb-1 font-semibold">Notas / Tratamiento</label>
                <textarea [(ngModel)]="nuevoHistorial.tratamiento_aplicado" name="notas" rows="3" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-secondary-teal"></textarea>
            </div>
            <div>
                <label class="block text-gray-700 mb-1 font-semibold">Medicamentos</label>
                <textarea [(ngModel)]="nuevoHistorial.medicamentos_recetados" name="meds" rows="2" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-secondary-teal"></textarea>
            </div>
        </div>
        <div class="flex justify-end p-5 border-t space-x-4">
            <button (click)="cerrarModalTratamiento()" class="bg-white border border-gray-300 px-4 py-2 rounded-lg text-gray-700">Cancelar</button>
            <button (click)="guardarTratamiento()" class="bg-secondary-teal text-white px-4 py-2 rounded-lg shadow-md hover:bg-opacity-80">Guardar</button>
        </div>
    </div>
</div>

<!-- ============================ -->
<!-- MODAL AGREGAR VACUNA -->
<!-- ============================ -->
<div *ngIf="mostrarModalVacuna" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-[60]">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg animate-fade-in-down">
        <div class="flex justify-between items-center p-5 border-b">
            <h3 class="text-xl font-bold text-primary-dark">Registrar Vacuna</h3>
            <button (click)="cerrarModalVacuna()" class="text-gray-400 hover:text-gray-600">X</button>
        </div>
        <div class="p-6 space-y-4">
            <div>
                <label class="block text-gray-700 mb-1 font-semibold">Vacuna</label>
                <select [(ngModel)]="nuevaVacuna.producto_id" name="vac_prod" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-secondary-teal">
                    <option [value]="0">Selecciona...</option>
                    <option *ngFor="let p of productos" [value]="p.id">{{ p.nombre }} (Stock: {{p.stock_actual}})</option>
                </select>
            </div>
            <div>
                <label class="block text-gray-700 mb-1 font-semibold">Veterinario</label>
                <select [(ngModel)]="nuevaVacuna.veterinario_id" name="vac_vet" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-secondary-teal">
                    <option [value]="0">Selecciona...</option>
                    <option *ngFor="let v of veterinarios" [value]="v.id">{{ v.nombre_completo }}</option>
                </select>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-gray-700 mb-1 font-semibold">Fecha Aplicación</label>
                    <input [(ngModel)]="nuevaVacuna.fecha_aplicacion" name="vac_fecha" type="date" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-secondary-teal">
                </div>
                <div>
                    <label class="block text-gray-700 mb-1 font-semibold">Próxima Dosis</label>
                    <input [(ngModel)]="nuevaVacuna.fecha_proxima" name="vac_prox" type="date" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-secondary-teal">
                </div>
            </div>
        </div>
        <div class="flex justify-end p-5 border-t space-x-4">
            <button (click)="cerrarModalVacuna()" class="bg-white border border-gray-300 px-4 py-2 rounded-lg text-gray-700">Cancelar</button>
            <button (click)="guardarVacuna()" class="bg-secondary-teal text-white px-4 py-2 rounded-lg shadow-md hover:bg-opacity-80">Guardar</button>
        </div>
    </div>
</div>

<!-- ============================ -->
<!-- MODAL ARCHIVAR -->
<!-- ============================ -->
<div *ngIf="mostrarModalArchivar" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-[60]">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg animate-fade-in-down">
        <div class="flex justify-between items-center p-5 border-b border-red-200">
            <h3 class="text-xl font-bold text-light-red">Archivar Mascota</h3>
            <button (click)="cerrarModalArchivar()" class="text-gray-400 hover:text-gray-600">X</button>
        </div>
        <div class="p-6">
            <p class="text-gray-700 mb-4">¿Estás seguro de que deseas archivar a <strong class="text-primary-dark">{{ mascotaSeleccionada?.nombre }}</strong>?</p>
            <p class="text-sm text-gray-500">Esto ocultará la mascota de la lista principal pero mantendrá su historial.</p>
        </div>
        <div class="flex justify-end p-5 border-t space-x-4">
            <button (click)="cerrarModalArchivar()" class="bg-white text-gray-700 border border-gray-300 font-semibold py-2 px-4 rounded-lg">Cancelar</button>
            <button (click)="archivarMascotaConfirmado()" class="bg-light-red text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-red-700">Confirmar</button>
        </div>
    </div>
</div>